<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link href="../../../Content/bootstrap.min.css" rel="stylesheet" />
    <link href="../../../Content/bootstrap-select.min.css" rel="stylesheet" />
    <script src="../../../Scripts/jquery-3.4.1.min.js"></script>
    <link href="../../Content/datetimepicker.css" rel="stylesheet" />
    <script src="../../../Scripts/bootstrap.min.js"></script>
    <script src="../../../Scripts/bootstrap-select.min.js"></script>
    <script src="../../Scripts/layer_v3.1.1/3.1.1/layer.js"></script>
    <script src="../../Scripts/datetimepicker/moment.js"></script>
    <script src="../../Scripts/datetimepicker/bootstrap-datetimepicker.js"></script>
    <title>考勤支付信息导入</title>
    <style>
        .bootstrap-select:not([class*=col-]):not([class*=form-control]):not(.input-group-btn) {
            width: 6.5em;
        }
        button[data-id="selectWorkSite"]{
	    color: red;
       }
    </style>
</head>
<body>
    <div id="main" class="container-fluid" style="width:100%;float:left;">

        <script src="../GetChangingHeight.js"></script>

        <div clase="col-lg-6 col-ms-8 col-xs-10" style="margin:2% 2%;font-size:1.45em;font-weight:500;line-height:1.9em;">

            <span>日期：</span>
            <div class="iDate date" style="width:8em">
                <input id="date" type="text">
                <button type="button" class="addOn"></button>
            </div>
            <script>
                /*
                if ($(".iDate.date").length > 0) {
                     $(".iDate.date").datetimepicker({
                         locale: "zh-cn",
                         format: "YYYY-MM-DD",
                         dayViewHeaderFormat: "YYYY年 MMDD"
                     });
                 };
                 let time = new Date().getTime() - 24 * 60 * 60 * 1000;
                 let yesday = new Date(time);
                 let month = yesday.getMonth();//0-11
                 if (month < 9) {
                     month = '0' + (month + 1);
                 }
                 else {
                     month = month + 1;
                 }
                 let day = yesday.getDate();//1-31
                 if (day < 9) {
                     day = '0' + day;
                 }
                 yesday = yesday.getFullYear() + '-' + month + '-' + day;
                 $("#date").val(yesday);
                 */
                if ($(".iDate.date").length > 0) {
                    $(".iDate.date").datetimepicker({
                        locale: "zh-cn",
                        format: "YYYY-MM-DD",
                        dayViewHeaderFormat: "YYYY年 MMDD"
                    });
                };

            </script>
            &nbsp; &nbsp;
            <span style="font-size:1em;">天气：</span>
            <select class="selectpicker" style="width:5em" id="weather">
                <option value="晴天">晴天（无雨雪）</option>
                <option value="雨雪">全天雨雪</option>
                <option value="上午雨雪">上午雨雪</option>
                <option value="下午雨雪">下午雨雪</option>
            </select>&nbsp; &nbsp;

            <span style="font-size:1em;">工地：</span>
            <select class="selectpicker" id="selectWorkSite" onChange="changSel('selectWorkSite')">
            </select>&nbsp; &nbsp;
            <span style="font-size:1em;">归属：</span>
            <select class="selectpicker" id="selectBelong">           
            </select> &nbsp; &nbsp;

            <span style="font-size:1em;">姓名：</span>
            <select class="selectpicker" id="selectName">
            </select> &nbsp; &nbsp;

            <div class="row" style="margin-top:2%;margin-bottom:1%;">
                <div style="margin-right:20%; text-align: center;margin-bottom:2% ">
                    <span style="font-size:1em;color:red;">录入结束后要查看下，</span>
                    <span style="font-size:1em;color:red;">通过“菜单-数据管理-录入数据稽核”进行核实，防止出现一个人出现在多个工地的异常数据。</span>
                </div>
                <div style="margin-right:20%; text-align: center ">
                    <span style="font-size:2em;font-weight:600;">考勤导入</span>
                    <br><br>
                </div>

                <div class="form-inline" style="margin:0 auto; margin-left:15%;">
                    <span style="font-size:1em;">当天工日：</span>
                    <input type="text" id="work" class="form-control" onblur="check(this)" onkeyup="this.value=this.value.replace(/[^0-9.]/g,'')" style="width:6em;" value="1" placeholder="当天工日">&nbsp; &nbsp;
                    <span style="font-size:1em;">加班：</span>
                    <input type="text" id="workMore" class="form-control" onblur="check(this)" onkeyup="this.value=this.value.replace(/[^0-9.]/g,'')" style="width: 10em;" value="0" placeholder="加班">&nbsp; &nbsp;
                    <span style="font-size:1em;">备注：</span>
                    <textarea type="text" id="remark" class="form-control" style="width: 20em;" placeholder="工作日志（20字左右）" rows="3"></textarea>
                </div>
                <br>
                <div style="margin-right:20%; text-align: center ">
                    <button type="button" class="btn-primary" onclick="workUpdate()">考勤数据导入</button>
                </div>
            </div>
            <br>
            <div class="row" style="margin-top:1%">
                <div style="margin-right:20%; text-align: center ">
                    <span style="font-size:2em;font-weight:600;">工资支付</span>
                    <br><br>
                </div>

                <div class="form-inline" style="margin:0 auto; margin-left:15%;">

                    <span style=" font-size: 1em;">支付工资：</span>
                    <input type="text" id="pay" class="form-control" onKeyUp="clearNoNum(event,this)" style="width: 6em;" value="0" placeholder="支付工资">
                    &nbsp; &nbsp;
                    <span style="font-size:1em;">方式：</span>
                    <select class="selectpicker" style="" id="payType">
                        <option value="微信"> 微信</option>
                        <option value="转账"> 转账</option>
                        <option value="现金"> 现金</option>
                        <option value="伙食"> 伙食</option>
                        <option value="罚款"> 罚款</option>
                    </select>&nbsp; &nbsp;
                    <span style="font-size:1em;">银行：</span>
                    <select class="selectpicker" style="" id="wageCard">
                        <option value="Cas">现金选项</option>
                        <option value="CCB"> 建设银行</option>
                        <option value="JS">  江苏银行</option>
                        <option value="NoPay">未支付</option>
                    </select>&nbsp; &nbsp;
                    <span style="font-size:1em;">备注：</span>
                    <textarea type="text" id="payRemark" class="form-control" style="width: 20em;" placeholder="支付缘由（分包付款也可以导入,支付不考虑天气因素）" rows="3"></textarea>
                </div>
                <br>
                <div style="margin-right:20%; text-align: center ">
                    <button type="button" class="btn-primary" onclick="workerPayUpdate()">支付数据导入</button>
                </div>
            </div>

        </div>

    </div>

    <script>
     
        const optoinUrl = '/api/ImPort/GetBasicInfo';
        const dataUrl = '/api/ImPort/GetImportWork';
        const dataPayUrl = '/api/ImPort/GetImportPay';
        //验证文本框只能输入数字和小数点
        function check(e) {
            let re = /^\d+(?=\.{0,1}\d+$|$)/
            if (e.value != "") {
                if (!re.test(e.value)) {
                    alert("请输入正确的数字");
                    e.value = "";
                    e.focus();
                }
            }
        }

        //判断只能输入纯数字或者小数点，及负整数
        function clearNoNum(event, obj) {
            //响应鼠标事件，允许左右方向键移动
            event = window.event || event;
            if (event.keyCode == 37 | event.keyCode == 39) {
                return;
            }
            var t = obj.value.charAt(0);
            //先把非数字的都替换掉，除了数字和.
            obj.value = obj.value.replace(/[^\d.]/g, "");
            //必须保证第一个为数字而不是.
            obj.value = obj.value.replace(/^\./g, "");
            //保证只有出现一个.而没有多个.
            obj.value = obj.value.replace(/\.{2,}/g, ".");
            //保证.只出现一次，而不能出现两次以上
            obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
            //如果第一位是负号，则允许添加   如果不允许添加负号 可以把这块注释掉
            if (t == '-') {
                obj.value = '-' + obj.value;
            }
        }


        $("#selectBelong").change(function (e) {

            loadWorker();
        });

        //加载人员归属和工地
        function loadWorkSite() {
      
            $.ajax({
                url: optoinUrl, //所需要的列表接口地址
                type: "get",
                dataType: "json",              
                async: false,
                success: function (data) {

                    document.getElementById("selectWorkSite").options.length = 0;


                    let listWorkSites = "";
                    for (let i = 0; i < data[1].length; i++) {
                        listWorkSites += "<option value='" + data[1][i] + "'>" + data[1][i] + "</option>";

                    }
                    $("#selectWorkSite").append(listWorkSites);
                    $('#selectWorkSite').selectpicker('refresh');
                    $('#selectWorkSite').selectpicker('render');

                     document.getElementById("selectBelong").options.length = 0;


                    let listWorkBelong = "";
                    for (let i = 0; i < data[2].length; i++) {
                        listWorkBelong += "<option value='" + data[2][i] + "'>" + data[2][i] + "</option>";

                    }
                    $("#selectBelong").append(listWorkBelong);
                    $('#selectBelong').selectpicker('refresh');
                    $('#selectBelong').selectpicker('render');
                },
                error: function (e) {
                    console.log(e.responseText);
                }
            });
        }
        //归属人员
        function loadWorker() {

            let selectBelong = $('#selectBelong').selectpicker('val');
            $.ajax({
                url: optoinUrl, //所需要的列表接口地址
                type: "get",
                dataType: "json",
                data: {
                    'selectBelong': selectBelong
                },
                async: false,
                success: function (data) {
                    document.getElementById("selectName").options.length = 0;

                    let listNames = "";
                    for (let i = 0; i < data[0].length; i++) {
                        listNames += "<option value='" + data[0][i] + "'>" + data[0][i] + "</option>";

                    }
                    $("#selectName").append(listNames);//append 添加进去并展示

                    //不能删下面俩行不然在ie下有问题
                    $('#selectName').selectpicker('refresh');
                    $('#selectName').selectpicker('render');


                },
                error: function (e) {
                    console.log(e.responseText);
                }
            });
        }
        loadWorkSite(); loadWorker();
        //工人工作记录导入
        function workUpdate() {
            let selectWeather = $('#weather').selectpicker('val');
            let selectName = $('#selectName').selectpicker('val');
            let date = $('#date').val();
            let selectWorkSite = $('#selectWorkSite').val();
            let work = $('#work').val();
            let workMore = $('#workMore').val();
            let remark = $('#remark').val();
            remark = remark.replaceAll("\n", "");
            remark = remark.replaceAll("\r", "");
            $.ajax({
                url: dataUrl, //所需要的列表接口地址
                type: "get",
                data: {
                    'selectWeather': selectWeather, 'selectName': selectName, 'date': date, 'selectWorkSite': selectWorkSite,
                    'work': work, 'workMore': workMore, 'remark': remark
                },//发送到服务器的数据，key/value形式
                dataType: "json",
                success: function (data) {

                    if (data == 'ok') {
                        alert('数据已经导入');
                        //删除Select选中value
                        //$("#selectName option[value="+selectName+"]").remove();
                    } else if (data == 'repeate') {
                        alert('请勿重复导入');
                    }

                },
                error: function (e) {
                    console.log(e.responseText);
                }
            });
        }

        //支付记录
        function workerPayUpdate() {
            let selectName = $('#selectName').selectpicker('val');
            let date = $('#date').val();
            let selectWorkSite = $('#selectWorkSite').val();
            let wageCard = $('#wageCard').val();
            let pay = $('#pay').val();
            let payType = $('#payType').val();
            let remark = $('#payRemark').val();
            $.ajax({
                url: dataPayUrl, //所需要的列表接口地址
                type: "get",
                data: {
                    'selectName': selectName, 'date': date, 'selectWorkSite': selectWorkSite,
                    'wageCard': wageCard, 'pay': pay, 'payType': payType, 'remark': remark
                },//发送到服务器的数据，key/value形式
                dataType: "json",
                success: function (data) {

                    if (data == 'ok') {
                        alert('支付数据已经导入');

                    } else if (data == 'repeate') {
                        alert('请勿重复导入');
                    }

                },
                error: function (e) {
                    console.log(e.responseText);
                }
            });
            $("#pay").val("");
            $("#payRemark").val("");

        }
        ////进入页面设置初始值
        //function setOriginDateValue() {
        //    let setDate = $("#date1").val();
        //    $("#date").val(setDate);
        //    //模拟点击，关闭弹窗
        //    var layer_close = document.getElementsByClassName("layui-layer-ico layui-layer-close layui-layer-close1");
        //    layer_close[0].click();
        //}

        String.prototype.replaceAll = function (s1, s2) {
            return this.replace(new RegExp(s1, "gm"), s2);
        }

        //页面加载完成
        window.onload = function () {


            //页面层
            layer.open({
                type: 1,
                title: ['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;录入日期设定', 'text-align:center;font-size:1.5em;font-weight:600;'],
                skin: 'layui-layer-rim', //加上边框
                area: ['280px', '150px'], //宽高
                offset: '220px',//坐标
                shadeClose: true,//点击阴影区弹窗自动关闭
                content: "<div class='form-group' style='margin:10% 25%;'>" +

                    "<div class='form-inline' style='margin-top:5%;margin-bottom:2%;' >" +
                    "<div id='idate1' class='iDate date' style='width:8em'>" +
                    "<input id='date1' type='text'>" +
                    "<button type='button' id='originBtn' class='addOn'></button>" +
                    "</div>" +
                    //"<button type='button' class='btn' onclick=\'setOriginDateValue()\'; style='background: #1caf9a; color: #FFFFFF; border: none;margin-left:5% ' >确定</button>" +
                    "</div>" +
                    "</div>"
            });

            if ($("#idate1").length > 0) {
                $("#idate1").datetimepicker({
                    locale: "zh-cn",
                    format: "YYYY-MM-DD",
                    dayViewHeaderFormat: "YYYY年 MMDD"
                });
            };
            $("#originBtn").click(function () {
                let zIndex = $("#layui-layer1").css("z-index");
                $(".dtPicker").css("z-index", zIndex + 1);
                //s事件控件 获取到第二个a 标签
                var lista = document.querySelectorAll(".picker-switch a")[1];

                //为a标签 添加click 事件
                lista.addEventListener("click", function () {
                    //模拟点击，关闭弹窗
                    var layer_close = document.getElementsByClassName("layui-layer-ico layui-layer-close layui-layer-close1");
                    layer_close[0].click();
                    let setDate = $("#date1").val();
                    $("#date").val(setDate);
                    //event.stopPropagation();    //  阻止事件冒泡
                });

            });





        };
    </script>

</body>

</html>
